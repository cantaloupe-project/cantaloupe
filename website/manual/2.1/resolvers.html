<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="High-performance dynamic image server in Java
">

  <title>
    Cantaloupe
    
      :: Resolvers
    
  </title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/cantaloupe/css/syntax.css">
  <link rel="stylesheet" href="/cantaloupe/css/base.css">

  <script src="/cantaloupe/scripts/jquery.min.js"></script>
</head>


  <body>

    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">

    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/cantaloupe/">
        <img alt="Cantaloupe" src="/cantaloupe/images/cantaloupe.png" width="40">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/cantaloupe/get-started.html">Get Started</a></li>
        <li><a href="/cantaloupe/manual/">User Manual</a></li>
        <li><a href="/cantaloupe/support.html">Support</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/medusa-project/cantaloupe/releases.atom" title="Subscribe to Releases"><img width="22" height="22" src="/cantaloupe/images/feed.svg"></a></li>
      </ul>
    </div>

  </div>
</nav>


      <div class="row">
  <div class="col-md-3 hidden-xs hidden-sm">
    <ul class="toc">
  <li><a href="changes.html">What's New in <span class="version">2.1</span></a></li>
  <li><a href="upgrading.html">Upgrading</a></li>
  <li>
    <a href="endpoints.html">Endpoints</a>
    <ul>
      <li><a href="endpoints.html#IIIFImageAPI1">IIIF Image API 1.x</a></li>
      <li><a href="endpoints.html#IIIFImageAPI2">IIIF Image API 2.x</a></li>
    </ul>
  </li>
  <li>
    <a href="deployment.html">Deployment</a>
    <ul>
      <li><a href="deployment.html#Hardware">Hardware</a></li>
      <li><a href="deployment.html#Limiting">Limiting</a></li>
      <li><a href="deployment.html#Reverse-Proxying">Reverse-Proxying</a></li>
      <li><a href="deployment.html#SSL%2FTLS">SSL/TLS</a></li>
    </ul>
  </li>
  <li>
    <a href="resolvers.html">Resolvers</a>
    <ul>
      <li><a href="resolvers.html#Static%20Resolver">Static Resolver</a></li>
      <li><a href="resolvers.html#Dynamic%20Resolvers">Dynamic Resolvers</a></li>
      <li><a href="resolvers.html#FilesystemResolver">Filesystem</a></li>
      <li><a href="resolvers.html#HttpResolver">HTTP</a></li>
      <li><a href="resolvers.html#JdbcResolver">JDBC</a></li>
      <li><a href="resolvers.html#AmazonS3Resolver">Amazon S3</a></li>
    </ul>
  </li>
  <li>
    <a href="processors.html">Processors</a>
    <ul>
      <li><a href="processors.html#Source%20Format%20Support">Format Support</a></li>
      <li><a href="processors.html#Compatibility">Resolver Compatibility</a></li>
      <li><a href="processors.html#Java2dProcessor">Java 2D</a></li>
      <li><a href="processors.html#GraphicsMagickProcessor">GraphicsMagick</a></li>
      <li><a href="processors.html#ImageMagickProcessor">ImageMagick</a></li>
      <li><a href="processors.html#JaiProcessor">JAI</a></li>
      <li><a href="processors.html#KakaduProcessor">Kakadu</a></li>
      <li><a href="processors.html#OpenJpegProcessor">OpenJPEG</a></li>
      <li><a href="processors.html#FfmpegProcessor">FFmpeg</a></li>
    </ul>
  </li>
  <li>
    <a href="caches.html">Caches (Server-Side)</a>
    <ul>
      <li><a href="caches.html#Purging">Purging</a></li>
      <li><a href="caches.html#FilesystemCache">Filesystem</a></li>
      <li><a href="caches.html#JdbcCache">JDBC</a></li>
    </ul>
  </li>
  <li><a href="client-caching.html">Caching (Client-Side)</a></li>
  <li>
    <a href="access-control.html">Access Control</a>
    <ul>
      <li><a href="access-control.html#Authentication">Authentication</a></li>
      <li><a href="access-control.html#Authorization">Authorization</a></li>
    </ul>
  </li>
  <li>
    <a href="logging.html">Logging</a>
    <ul>
      <li><a href="logging.html#Application%20Log">Application Log</a></li>
      <li><a href="logging.html#Access%20Log">Access Log</a></li>
    </ul>
  </li>
  <li>
    <a href="source-formats.html">Source Formats</a>
    <ul>
      <li><a href="source-formats.html#JPEG">JPEG</a></li>
      <li><a href="source-formats.html#JPEG2000">JPEG2000</a></li>
      <li><a href="source-formats.html#TIFF">TIFF</a></li>
    </ul>
  </li>
  <li><a href="delegate-script.html">Delegate Script</a></li>
  <li>
    <a href="developers.html">For Developers</a>
    <ul>
      <li><a href="/cantaloupe/javadoc/2.1/">Javadoc</a></li>
      <li><a href="developers.html#Contributing">Contributing</a></li>
    </ul>
  </li>
</ul>

  </div>

  <div class="col-sm-12 col-md-9">
    <div class="alert alert-warning">
  This manual is for a previous version. <a href="/cantaloupe/manual/">See all versions</a>
</div>

    <ol class="breadcrumb">
  <li><a href="/cantaloupe/">Home</a></li>
  <li><a href="/cantaloupe/manual/">User Manual</a></li>
  <li><a href="/cantaloupe/manual/2.1/">2.1</a></li>
  <li class="active">Resolvers</li>
</ol>

<h1>Resolvers</h1>

<ul>
  <li><a href="#Static%20Resolver">Static Resolver</a></li>
  <li><a href="#Dynamic%20Resolvers">Dynamic Resolvers</a></li>
  <li><a href="#FilesystemResolver">FilesystemResolver</a></li>
  <li><a href="#HttpResolver">HttpResolver</a></li>
  <li><a href="#JdbcResolver">JdbcResolver</a></li>
  <li><a href="#AmazonS3Resolver">AmazonS3Resolver</a></li>
</ul>

<p>Resolvers locate a source image based on the image identifier in a request URL. In programmer-speak, they take in an identifier and return a source object from which the corresponding image can be read by a <a href="processors.html">processor</a>.</p>

<p>(This distinction is important because <a href="processors.html#Compatibility">not all processors can work with all resolvers</a>.)</p>

<p>The resolution process can be configured to be <a href="#Static%20Resolver">static</a>&mdash;with all requests using the same resolver&mdash;or <a href="#Dynamic%20Resolvers">dynamic</a>, with images being served from different resolvers depending on their identifier.</p>

<h2 id="Static Resolver">Static Resolver</h2>

<p>When the <code>resolver.static</code> configuration key is set to the name of a resolver, Cantaloupe will use that resolver for all requests. This is simple and should work in most scenarios.</p>

<h2 id="Dynamic Resolvers">Dynamic Resolvers</h2>

<p>When a static resolver is not flexible enough, it is also possible to serve images from different sources simultaneously. For example, you may have some images stored on a filesystem, and others stored on Amazon S3. <em>If you can differentiate their sources based on their identifier in code</em>&mdash;either by analyzing the identifier string, or performing some kind of service request&mdash;you can use the <a href="delegate-script.html">delegate script</a> mechanism to write a simple Ruby method to tell Cantaloupe which resolver to use for a given request.</p>

<p>To enable dynamic resolver selection, set the <code>resolver.delegate</code> configuration key to <code>true</code>. Then, implement the <code>get_resolver(identifier)</code> method in the delegate script, which takes in an identifier and returns a resolver name (such as FilesystemResolver, HttpResolver, etc.) For example:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_resolver</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="c1"># Here, you would perform some kind of analysis on `identifier`:</span>
    <span class="c1"># parse it, look it up in a web service or database...</span>
    <span class="c1"># and then return the name of the resolver to use to serve it.</span>
    <span class="s1">'FilesystemResolver'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script.</p>

<h2 id="FilesystemResolver">FilesystemResolver</h2>

<p>FilesystemResolver maps a URL identifier to a filesystem path, for retrieving images on a local or attached filesystem. In addition to being the most compatible resolver, <strong>this is also the most efficient resolver</strong> and may or may not be the only option for serving very large source images.</p>

<p>For images with extensions that are missing or unrecognized, this resolver will check the "magic number" to determine type, which will add some overhead. It is therefore slightly more efficient to serve images with extensions.</p>

<p>FilesystemResolver supports two distinct lookup strategies, defined by the <code>FilesystemResolver.lookup_strategy</code> configuration option.</p>

<h3>BasicLookupStrategy</h3>

<p>BasicLookupStrategy locates images by concatenating a pre-defined path prefix and/or suffix. For example, with the following configuration options set:</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="c"># Note trailing slash!
</span><span class="py">FilesystemResolver.BasicLookupStrategy.path_prefix</span> <span class="p">=</span> <span class="s">/usr/local/images/</span>
<span class="py">FilesystemResolver.BasicLookupStrategy.path_suffix</span> <span class="p">=</span></code></pre></figure>

<p>An identifier of <code>image.jpg</code> in the URL will resolve to
<span class="filename">/usr/local/images/image.jpg</span>.</p>

<p>To prevent arbitrary directory traversal, BasicLookupStrategy will strip out <code>..{path separator}</code> and <code>{path separator}..</code> from identifiers before resolving the path.</p>

<div class="alert alert-danger">Note: it is dangerous to <strong>not</strong> use <code>path_prefix</code>. The shallower the path, the more of the filesystem that will be exposed.</div>

<h3 id="FilesystemResolverScriptLookupStrategy">ScriptLookupStrategy</h3>

<p>Sometimes, BasicLookupStrategy will not offer enough control. Perhaps you want to serve images from multiple filesystems, or perhaps your identifiers are opaque and you need to perform a database or web service request to locate the corresponding images. With this lookup strategy, you can tell FilesystemResolver to invoke a method in your <a href="delegate-script.html">delegate script</a> and capture the pathname it returns.</p>

<p>The delegate script method, <code>get_pathname(identifier)</code>, will take in an identifier and should return a pathname, if available, or <code>nil</code>, if not. A Solr query, for example, could look like:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s1">'cgi'</span>

<span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_pathname</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s1">'http://localhost:8983/solr/collection1/select?q='</span> <span class="o">+</span>
        <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'id:"'</span> <span class="o">+</span> <span class="n">identifier</span> <span class="o">+</span> <span class="s1">'"'</span><span class="p">)</span> <span class="o">+</span>
        <span class="s1">'&amp;amp;fl=pathname_si&amp;amp;wt=ruby'</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Get</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">request_uri</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">&gt;=</span> <span class="mi">400</span>

    <span class="n">results</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)[</span><span class="s1">'response'</span><span class="p">][</span><span class="s1">'docs'</span><span class="p">]</span>
    <span class="n">results</span><span class="p">.</span><span class="nf">any?</span> <span class="p">?</span> <span class="n">results</span><span class="p">.</span><span class="nf">first</span><span class="p">[</span><span class="s1">'pathname_si'</span><span class="p">]</span> <span class="p">:</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script.</p>

<hr>

<h2 id="HttpResolver">HttpResolver</h2>

<p>HttpResolver maps a URL identifier to an HTTP or HTTPS resource, for retrieving images from a web server.</p>

<p>It is preferable to use this resolver with source images with recognizable file extensions. For images with an extension that is missing or unrecognizable, it will issue an HTTP HEAD request to the server to check the <code>Content-Type</code> header. If the type cannot be inferred from that, an HTTP 415 response will be returned.</p>

<p>HttpResolver supports two distinct lookup strategies, defined by the <code>HttpResolver.lookup_strategy</code> configuration option.</p>

<h3>BasicLookupStrategy</h3>

<p>BasicLookupStrategy locates images by concatenating a pre-defined URL prefix and/or suffix. For example, with the following configuration options set:</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="c"># Note trailing slash!
</span><span class="py">HttpResolver.url_prefix</span> <span class="p">=</span> <span class="s">http://example.org/images/</span>
<span class="py">HttpResolver.url_suffix</span> <span class="p">=</span></code></pre></figure>

<p>An identifier of <code>image.jpg</code> in the URL will resolve to
<span class="filename">http://example.org/images/image.jpg</span>.

<h3>ScriptLookupStrategy</h3>

<p>Sometimes, BasicLookupStrategy will not offer enough control. Perhaps you want to serve images from multiple URLs, or perhaps your identifiers are opaque and you need to run a database or web service request to locate them.  With this lookup strategy, you can tell FilesystemResolver to invoke a method in your <a href="delegate-script.html">delegate script</a> and capture the URL it returns.</p>

<p>The delegate script method, <code>get_url(identifier)</code>, will take in an identifier and should return a URL, if available, or <code>nil</code>, if not. See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script, and the <a href="#FilesystemResolverScriptLookupStrategy">FilesystemResolver ScriptLookupStrategy</a> section for an example of a similar script.</p>

<hr>

<h2 id="JdbcResolver">JdbcResolver</h2>

<p>JdbcResolver maps a URL identifier to an RDBMS BLOB field, for retrieving images from a relational database.</p>

<p>Cantaloupe does not include any JDBC drivers, so a driver JAR for the desired database must be obtained separately and saved somewhere on the classpath.</p>

<p>The JDBC connection is initialized by the <code>JdbcResolver.url</code>, <code>JdbcResolver.user</code>, and <code>JdbcResolver.password</code> configuration options. If the user or password are not necessary, they can be left blank. The connection string must use your driver's JDBC syntax:</p>

<pre><code>jdbc:postgresql://localhost:5432/my_database
jdbc:mysql://localhost:3306/my_database
jdbc:microsoft:sqlserver://example.org:1433;DatabaseName=MY_DATABASE</code></pre>

<p>Consult the driver's documentation for details.</p>

<p>Then, the resolver needs to be told:</p>

<ol>
  <li><a href="#JdbcResolverIdentifierFunction">The database value corresponding to a given identifier</a></li>
  <li><a href="#JdbcResolverMediaTypeFunction">The media type corresponding to that value</a></li>
  <li><a href="#JdbcResolverBlobSQL">The SQL command that retrieves the BLOB corresponding to that value</a></li>
</ol>

<h3 id="JdbcResolverIdentifierFunction">Database Identifier Retrieval Function</h3>

<p>This JavaScript function takes in an unencoded identifier and returns the corresponding database value of the identifier. For example, the following will work when the identifiers in the URL map directly to values in the database:</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="py">JdbcResolver.function.identifier</span> <span class="p">=</span> <span class="s">function getDatabaseIdentifier(url_identifier) {</span><span class="se">\
</span>      <span class="s">return url_identifier;</span><span class="se">\
</span>  <span class="s">}</span></code></pre></figure>

<p>Otherwise, if the URL identifiers require some transformation first:</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="py">JdbcResolver.function.identifier</span> <span class="p">=</span> <span class="s">function getDatabaseIdentifier(url_identifier) {</span><span class="se">\
</span>        <span class="s">// Assumes that the identifier is stored in the database as</span><span class="se">\
</span>        <span class="s">// "identifier-something"</span><span class="se">\
</span>        <span class="s">return url_identifier + "-something";</span><span class="se">\
</span>    <span class="s">}</span></code></pre></figure>

<div class="alert alert-info">Note that in properties files, all lines in multi-line strings except the last need to end with a backslash (\).</div>

<h3 id="JdbcResolverMediaTypeFunction">Media Type Retrieval Function</h3>

<p>This JavaScript function returns a media (MIME) type corresponding to the value returned by the <code><a href="#JdbcResolverIdentifierFunction">getDatabaseIdentifier()</a></code> function. If the media type is stored in the database, this example will return an SQL statement to retrieve it.</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="py">JdbcResolver.function.media_type</span> <span class="p">=</span> <span class="s">function getMediaType(identifier) {</span><span class="se">\
</span>      <span class="s">return "SELECT media_type " +</span><span class="se">\
</span>          <span class="s">"FROM some_table "</span> <span class="s">+</span><span class="se">\
</span>          <span class="s">"WHERE some_identifier = ?"</span><span class="se">\
</span>  <span class="s">}</span></code></pre></figure>

<p>If the URL identifier will <strong>always</strong> have a known, valid image extension, like <span class="filename">.jpg</span>, <span class="filename">.tif</span>, etc., the entire <code>JdbcResolver.function.media_type</code> option can be commented out, and Cantaloupe will infer the media type from the extension.</p>

<h3 id="JdbcResolverBlobSQL">BLOB Retrieval SQL</h3>

<p><code>JdbcResolver.lookup_sql</code> is an SQL statement that selects the BLOB corresponding to the value returned by the <code><a href="#JdbcResolverIdentifierFunction">getDatabaseIdentifier()</a></code> function.</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="py">JdbcResolver.lookup_sql</span> <span class="p">=</span> <span class="s">SELECT image_blob_column </span><span class="se">\
</span>    <span class="s">FROM some_table </span><span class="se">\
</span>    <span class="s">WHERE some_identifier = ?</span></code></pre></figure>

<hr>

<h2 id="AmazonS3Resolver">AmazonS3Resolver</h2>

<p>AmazonS3Resolver maps a URL identifier to an Amazon S3 object, for retrieving images from Amazon S3. It can be configured with the following options:</p>

<dl>
  <dt><code>AmazonS3Resolver.access_key_id</code></dt>
  <dd>An access key associated with your AWS account. (See <a href="http://aws.amazon.com/security-credentials">AWS Security Credentials</a>.)</dd>
  <dt><code>AmazonS3Resolver.secret_key</code></dt>
  <dd>A secret key associated with your AWS account. (See <a href="http://aws.amazon.com/security-credentials">AWS Security Credentials</a>.)</dd>
  <dt><code>AmazonS3Resolver.bucket.name</code></dt>
  <dd>Name of the bucket containing the images to be served.</dd>
  <dt><code>AmazonS3Resolver.bucket.region</code></dt>
  <dd>Name of a region to send requests to, such as <code>us-east-1</code>. Can be commented out or left blank to use a default region. (See <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region">S3 Regions</a>.)</dd>
  <dt><code>AmazonS3Resolver.lookup_strategy</code></dt>
  <dd>The strategy to use to look up images based on their URL identifier. See below.</dd>
</dl>

<h3>BasicLookupStrategy</h3>

<p>BasicLookupStrategy locates images by passing the URL identifier as-is to S3, with no additional configuration necessary or possible.</p>

<h3>ScriptLookupStrategy</h3>

<p>When your URL identifiers don't match your Amazon S3 object keys, ScriptLookupStrategy is available to tell AmazonS3Resolver to capture the object key returned by a method in your <a href="delegate-script.html">delegate script</a>.</p>

<p>The delegate script method, <code>get_s3_object_key(identifier)</code>, will take in an identifier and should return an S3 object key string, if available, or <code>nil</code>, if not. See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script, and the <a href="#FilesystemResolverScriptLookupStrategy">FilesystemResolver ScriptLookupStrategy</a> section for an example of a similar script.</p>

  </div>
</div>


      <footer>
</footer>

<script src="/cantaloupe/scripts/bootstrap.min.js"></script>
<script src="/cantaloupe/scripts/base.js"></script>

    </div>

  </body>

</html>
